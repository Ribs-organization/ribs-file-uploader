class RibsFileUploader{constructor(e={}){document.querySelectorAll("[data-ribs-fileuploader]").forEach(e=>{this.initHtmlElements(e)}),this.uploadProgress=[],this.defineOptions(e),this.initEventListeners()}defineOptions(e){e.url||(e.url=""),e.deleteUrl||(e.deleteUrl=""),e.retrieveFilesUrl||(e.retrieveFilesUrl=""),this.options=e}initHtmlElements(e){const t=document.createElement("div");t.id=`inner-${e.id}`,t.classList.add("ribs-fileuploader"),e.parentNode.insertBefore(t,e),t.appendChild(e);const r=document.createElement("label");r.textContent="Sélectionnez des fichiers",r.setAttribute("for",e.id),t.append(r);const i=document.createElement("div");i.classList.add("ribs-fileuploader-text"),i.textContent="Ou déposez les ici",t.append(i);const l=document.createElement("div");l.classList.add("progress"),l.max=100,l.value=0,t.append(l);const s=document.createElement("input");s.type="hidden",s.id=`${e.id}-file-number`,s.value=0,t.append(s);const a=document.createElement("div");l.append(a);const n=document.createElement("div");n.classList.add("ribs-fileuploader-gallery"),t.append(n)}initEventListeners(){this.initPreventDefaultsEvents(),this.initDragEnterEvents(),this.initDragOutEvents(),this.initDropEvents(),this.initInputFileOnchange(),this.initRetrieveFiles()}initPreventDefaultsEvents(){["dragenter","dragover","dragleave","drop"].forEach(e=>{document.body.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation()},!1),document.querySelectorAll(".ribs-fileuploader").forEach(t=>{t.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation()},!1)})})}initDragEnterEvents(){["dragenter","dragover"].forEach(e=>{document.querySelectorAll(".ribs-fileuploader").forEach(t=>{t.addEventListener(e,()=>{t.classList.add("is-dragover")},!1)})})}initDragOutEvents(){["dragleave","drop"].forEach(e=>{document.querySelectorAll(".ribs-fileuploader").forEach(t=>{t.addEventListener(e,()=>{t.classList.remove("is-dragover")},!1)})})}initDropEvents(){document.querySelectorAll(".ribs-fileuploader").forEach(e=>{e.addEventListener("drop",t=>{this.handleFilesUpload(t,e)},!1)})}initInputFileOnchange(){document.querySelectorAll(".ribs-fileuploader").forEach(e=>{e.querySelector("input[type=file]").addEventListener("change",t=>{this.handleFilesUpload(t,e,!0)},!1)})}initRetrieveFiles(){document.querySelectorAll(".ribs-fileuploader").forEach(e=>{const t=this.retrieveParameter(e,"retrieveUrlParam"),r=this.retrieveUrl(this.options.retrieveFilesUrl,t);if(!r||""==r)return console.error(`Url to retrieve file can't be null for uploader id ${e.id}`),!1;const i=new XMLHttpRequest;i.open("POST",r,!0),i.setRequestHeader("Accept","application/json"),i.addEventListener("readystatechange",()=>{if(4==i.readyState&&200==i.status){const t=JSON.parse(i.response);if(t.files&&t.files.length>0){e.classList.add("has-files");for(const r of t.files){this.appendPreviewImageDiv(e,r.file_path,r.index),this.appendUploadElements(e,JSON.stringify(r),r.index);const t=e.querySelector('[id*="file-number"]');t.value=parseInt(t.value)+1}}}else 4==i.readyState&&200!=i.status&&console.log("error")}),i.send(this.buildFormData(t))})}handleFilesUpload(e,t,r=!1){let i;t.classList.add("has-files");const l=e.dataTransfer;i=r?[...e.currentTarget.files]:[...l.files];const s=t.querySelector('[id*="file-number"]');let a=0;0===parseInt(s.value)?s.value=parseInt(s.value)+i.length:(s.value=parseInt(s.value)+i.length,a=parseInt(s.value)-i.length),this.initializeProgress(t,i.length),i.forEach((e,r)=>{this.uploadFile(e,a+r,r,t)}),i.forEach((e,r)=>{this.previewFile(e,t,a+r)})}initializeProgress(e,t){this.uploadProgress[e.id]=[];for(let r=t;r>0;r--)this.uploadProgress[e.id].push(0)}updateProgress(e,t,r){const i=e.querySelector(".progress").querySelector("div");this.uploadProgress[e.id][t]=r;let l=this.uploadProgress[e.id].reduce((e,t)=>e+t,0)/this.uploadProgress[e.id].length;i.style.width=`${l}%`,100===l&&i.classList.add("uploaded")}retrieveParameter(e,t){const r=e.querySelector("input[type=file]").dataset[t];if(r)try{return JSON.parse(r)}catch(e){return console.warn("Erreur in uploader JSON"),!1}return!1}retrieveUrl(e,t){return t&&t.url&&""!==t.url?t.url:e&&""!==e?e:null}buildFormData(e,t=null){const r=new FormData;for(const t in e)"url"!==t&&r.append(t,e[t]);return t&&r.append("file",t),r}uploadFile(e,t,r,i){const l=this.retrieveParameter(i,"urlParam"),s=this.retrieveUrl(this.options.url,l);if(!s||""==s)return console.error(`Url to upload file can't be null for uploader id ${i.id}`),!1;const a=new XMLHttpRequest;a.open("POST",s,!0),a.setRequestHeader("Accept","application/json"),a.upload.addEventListener("progress",e=>{this.updateProgress(i,r,100*e.loaded/e.total||100)}),a.addEventListener("readystatechange",()=>{4==a.readyState&&200==a.status?this.appendUploadElements(i,a.response,t):4==a.readyState&&200!=a.status&&console.log("error")}),a.send(this.buildFormData(l,e))}appendUploadElements(e,t,r){const i=e.querySelector("input[type=file").id,l=document.createElement("input");l.type="hidden",l.value=t,l.name=`${i}s[]`,l.id=`input-uploaded-file-${r}`,e.append(l);const s=e.querySelector(`#uploaded-file-${r}`);s.classList.add("uploaded"),s.querySelector("div").addEventListener("click",t=>this.deleteFile(t,e))}previewFile(e,t,r){let i=new FileReader;i.readAsDataURL(e),i.onloadend=(()=>{this.appendPreviewImageDiv(t,i.result,r)})}appendPreviewImageDiv(e,t,r){const i=document.createElement("img");i.src=t;const l=document.createElement("div");l.id=`uploaded-file-${r}`;const s=document.createElement("div");s.id=`uploaded-file-delete-${r}`,s.textContent="X",l.appendChild(s),l.appendChild(i),e.querySelector(".ribs-fileuploader-gallery").appendChild(l)}deleteFile(e,t){const r=this.retrieveParameter(t,"deleteUrlParam"),i=this.retrieveUrl(this.options.deleteUrl,r);if(!i||""==i)return console.error(`Url to delete file can't be null for uploader id ${t.id}`),!1;const l=e.currentTarget.parentNode,s=t.querySelector(`#input-${l.id}`),a=JSON.parse(s.value),n=new XMLHttpRequest;n.open("POST",i,!0),n.setRequestHeader("Accept","application/json"),n.addEventListener("readystatechange",()=>{if(4==n.readyState&&200==n.status){if(JSON.parse(n.response).success&&(l.remove(),s.remove(),0===t.querySelector(".ribs-fileuploader-gallery").childNodes.length)){t.classList.remove("has-files");const e=t.querySelector(".progress > div");e.classList.remove("uploaded"),e.style.width="0%"}}else 4==n.readyState&&200!=n.status&&console.log("error")});const d=this.buildFormData(r);d.append("file_path",a.file_path),d.append("file_name",a.new_filename?a.new_filename:a.filename),n.send(d)}}export default RibsFileUploader;